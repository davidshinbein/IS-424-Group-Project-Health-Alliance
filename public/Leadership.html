<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Global Health Alliance UW-Madison</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
    />
    <link rel="stylesheet" href="/styles/header.css" />
    <link rel="stylesheet" href="/styles/leadership.css" />
    <style>
      .event-box {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 14px;
        background: #fff;
      }
      .admin-panel {
        border: 2px solid #192d86;
        border-radius: 12px;
        padding: 16px;
        background: #fff;
        max-width: 900px;
        margin: 0 auto 1.5rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      }
      .modal-card {
        max-width: 900px;
        width: 100%;
      }
      .is-hidden {
        display: none !important;
      }
      .leader-row {
        display: flex;
        align-items: center;
        margin-bottom: 2rem;
        gap: 2rem;
      }
      .leader-row.reverse {
        flex-direction: row-reverse;
      }
      .leader-image img {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
      }
      .leader-info {
        flex: 1;
      }
      .leader-name {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .leader-title {
        font-size: 1.1rem;
        color: #192d86;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      .leader-bio {
        line-height: 1.6;
      }
    </style>
    <base href="/" />
  </head>
  <body>
    <!-- Header -->
    <header class="has-text-centered p-0">
      <figure class="image is-64x64 is-inline-block">
        <img src="/images/ghalogo.png" alt="logo" />
      </figure>
      <h1 class="title has-text-white">Global Health Alliance UW-Madison</h1>

      <nav class="navbar">
        <div class="navbar-menu is-active is-flex is-justify-content-center">
          <a class="navbar-item has-text-white" href="index.html">Home</a>
          <a class="navbar-item has-text-white" href="what-we-do.html"
            >What We Do</a
          >
          <a class="navbar-item has-text-white" href="Leadership.html"
            >Meet The Team</a
          >
          <a class="navbar-item has-text-white" href="calendar.html"
            >Calendar</a
          >
          <a class="navbar-item has-text-white" href="get-involved.html"
            >Get Involved & Member Requirements</a
          >
          <a class="navbar-item has-text-white" href="globalpartners.html"
            >Global Partners</a
          >
        </div>
      </nav>
    </header>

    <!-- Main -->
    <main class="section p-0">
      <section class="section">
        <div class="leadership-section">
          <h1 class="title has-text-centered mb-6">
            2025-2026 Leadership Team
          </h1>

          <!-- Dynamic leader list -->
          <div id="leaderList">
            <p class="has-text-centered">Loading leadership team...</p>
          </div>

          <!-- Admin controls -->
          <section class="mt-5 mb-4 has-text-centered">
            <button class="button is-link is-light" id="openLeadAdminModal">
              Admin Login
            </button>
            <p class="is-size-7 has-text-grey mt-2">
              For Global Health Alliance exec/admin use only.
            </p>
          </section>

          <!-- Admin Modal -->
          <div id="leadAdminModal" class="modal">
            <div class="modal-background"></div>
            <div class="modal-card">
              <header class="modal-card-head">
                <p class="modal-card-title">Admin Panel</p>
                <button
                  class="delete"
                  aria-label="close"
                  id="closeLeadAdminModal"
                ></button>
              </header>

              <section class="modal-card-body">
                <div id="leadAdminPanel" class="admin-panel mb-0">
                  <!-- Auth block -->
                  <div id="leadAuthBlock" class="mb-4">
                    <div class="columns">
                      <div class="column is-half">
                        <label class="label">Admin Email</label>
                        <input
                          id="leadEmail"
                          class="input"
                          type="email"
                          placeholder="admin@example.com"
                        />
                      </div>
                      <div class="column is-half">
                        <label class="label">Password</label>
                        <input
                          id="leadPassword"
                          class="input"
                          type="password"
                          placeholder="Password"
                        />
                      </div>
                    </div>
                    <div class="buttons">
                      <button
                        id="leadSignInBtn"
                        class="button is-link is-light"
                      >
                        Sign In
                      </button>
                      <button
                        id="leadSignOutBtn"
                        class="button is-danger is-light"
                      >
                        Sign Out
                      </button>
                    </div>
                    <p id="leadAuthMsg" class="has-text-weight-bold mt-2"></p>
                  </div>

                  <!-- Profile create/update form (admins only) -->
                  <form id="leaderForm" class="mb-5 is-hidden">
                    <input type="hidden" id="leaderId" />
                    <div class="columns">
                      <div class="column">
                        <label class="label">Full Name</label>
                        <input id="leaderName" class="input" required />
                      </div>
                      <div class="column">
                        <label class="label">Title</label>
                        <input id="leaderTitle" class="input" required />
                      </div>
                    </div>
                    <div class="field">
                      <label class="label">Image URL</label>
                      <input
                        id="leaderImage"
                        class="input"
                        placeholder="/images/NAME.png"
                      />
                      <p class="help">Enter the path to the profile image</p>
                    </div>
                    <div class="field">
                      <label class="label">Bio</label>
                      <textarea
                        id="leaderBio"
                        class="textarea"
                        rows="5"
                      ></textarea>
                    </div>
                    <div class="buttons">
                      <button class="button is-link" type="submit">
                        Save Profile
                      </button>
                      <button
                        class="button is-light"
                        id="leadResetBtn"
                        type="button"
                      >
                        Clear Form
                      </button>
                    </div>
                    <p id="leadFormMsg" class="has-text-weight-bold mt-2"></p>
                  </form>

                  <!-- Admin list -->
                  <div id="leadAdminList" class="is-hidden">
                    <h4 class="title is-6">All Profiles</h4>
                    <div id="allLeaders"></div>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer has-text-centered">
      <p>&copy; 2025 Global Health Alliance UW-Madison</p>
      <p>gha.uwmadison@gmail.com</p>
    </footer>

    <!-- Firebase integration -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        onSnapshot,
        doc,
        getDoc,
        setDoc,
        addDoc,
        deleteDoc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyA7LwW6tkidme79K4hztoGFI-uf90JR4Kk",
        authDomain: "is-424-global-health-alliance.firebaseapp.com",
        projectId: "is-424-global-health-alliance",
        storageBucket: "is-424-global-health-alliance.firebasestorage.app",
        messagingSenderId: "174606565995",
        appId: "1:174606565995:web:5f4a37ae7cfc023eb3a72e",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Elements
      const leaderList = document.getElementById("leaderList");
      const openLeadAdminModalBtn =
        document.getElementById("openLeadAdminModal");
      const closeLeadAdminModalBtn = document.getElementById(
        "closeLeadAdminModal"
      );
      const leadAdminModal = document.getElementById("leadAdminModal");
      const leadModalBg = leadAdminModal?.querySelector(".modal-background");

      const leadEmail = document.getElementById("leadEmail");
      const leadPassword = document.getElementById("leadPassword");
      const leadSignInBtn = document.getElementById("leadSignInBtn");
      const leadSignOutBtn = document.getElementById("leadSignOutBtn");
      const leadAuthMsg = document.getElementById("leadAuthMsg");

      const leaderForm = document.getElementById("leaderForm");
      const leaderIdEl = document.getElementById("leaderId");
      const leaderNameEl = document.getElementById("leaderName");
      const leaderTitleEl = document.getElementById("leaderTitle");
      const leaderImageEl = document.getElementById("leaderImage");
      const leaderBioEl = document.getElementById("leaderBio");
      const leadFormMsg = document.getElementById("leadFormMsg");
      const leadResetBtn = document.getElementById("leadResetBtn");
      const leadAdminList = document.getElementById("leadAdminList");
      const allLeaders = document.getElementById("allLeaders");

      // Modal controls
      function openModal() {
        leadAdminModal.classList.add("is-active");
      }
      function closeModal() {
        leadAdminModal.classList.remove("is-active");
      }

      openLeadAdminModalBtn?.addEventListener("click", openModal);
      closeLeadAdminModalBtn?.addEventListener("click", closeModal);
      leadModalBg?.addEventListener("click", closeModal);

      // Check if user is admin (same as events page)
      async function isAdmin(uid) {
        if (!uid) return false;
        try {
          const snap = await getDoc(doc(db, "admins", uid));
          return snap.exists();
        } catch (err) {
          console.error("Error checking admin status:", err);
          return false;
        }
      }

      // Public list of leaders (order by name)
      const pubQ = query(collection(db, "leaders"), orderBy("name", "asc"));
      onSnapshot(
        pubQ,
        (snap) => {
          leaderList.innerHTML = "";
          if (snap.empty) {
            leaderList.innerHTML =
              "<p class='has-text-centered'>No leadership profiles available yet.</p>";
            return;
          }

          let isReverse = false;
          snap.forEach((s) => {
            const ld = s.data();
            const row = document.createElement("div");
            row.className = `leader-row ${isReverse ? "reverse" : ""}`;
            const imgSrc = ld.image || "/images/placeholder.png";

            row.innerHTML = `
              <div class="leader-image">
                <img src="${imgSrc}" alt="${
              ld.name || "Leader"
            }" onerror="this.src='/images/placeholder.png'" />
              </div>
              <div class="leader-info">
                <div class="leader-name">${ld.name || "Name not provided"}</div>
                <div class="leader-title">${
                  ld.title || "Title not provided"
                }</div>
                <p class="leader-bio">${ld.bio || ""}</p>
              </div>
            `;
            leaderList.appendChild(row);
            isReverse = !isReverse;
          });
        },
        (err) => {
          console.error("Error loading leaders:", err);
          leaderList.innerHTML =
            "<p class='has-text-centered has-text-danger'>Unable to load leadership profiles.</p>";
        }
      );

      // Admin view: all leaders
      const adminQ = query(collection(db, "leaders"), orderBy("name", "asc"));
      onSnapshot(
        adminQ,
        (snap) => {
          if (!allLeaders) return;
          allLeaders.innerHTML = "";

          snap.forEach((s) => {
            const ld = s.data();
            const div = document.createElement("div");
            div.className = "event-box";
            div.innerHTML = `
              <p class="has-text-weight-bold">${ld.name || "(no name)"}</p>
              <p><strong>Title:</strong> ${ld.title || "N/A"}</p>
              ${
                ld.bio
                  ? `<p class="mt-2">${ld.bio.substring(0, 150)}${
                      ld.bio.length > 150 ? "..." : ""
                    }</p>`
                  : ""
              }
              <div class="buttons mt-2">
                <button class="button is-small is-link" data-edit="${
                  s.id
                }">Edit</button>
                <button class="button is-small is-danger" data-del="${
                  s.id
                }">Delete</button>
              </div>
            `;
            allLeaders.appendChild(div);
          });

          allLeaders
            .querySelectorAll("[data-edit]")
            .forEach((btn) =>
              btn.addEventListener("click", () => loadForEdit(btn.dataset.edit))
            );
          allLeaders
            .querySelectorAll("[data-del]")
            .forEach((btn) =>
              btn.addEventListener("click", () => doDelete(btn.dataset.del))
            );
        },
        (err) => {
          console.error("Error loading admin list:", err);
        }
      );

      // Sign in (same as events page)
      leadSignInBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        leadAuthMsg.textContent = "Signing in...";
        leadAuthMsg.className = "has-text-info has-text-weight-bold mt-2";

        try {
          const email = leadEmail.value.trim();
          const pass = leadPassword.value;

          if (!email || !pass) {
            leadAuthMsg.textContent = "Enter email and password";
            leadAuthMsg.className = "has-text-danger has-text-weight-bold mt-2";
            return;
          }

          console.log("[auth] sign in click", email);
          const cred = await signInWithEmailAndPassword(auth, email, pass);
          console.log("[auth] signed in", cred.user.uid);
          leadAuthMsg.className = "has-text-success has-text-weight-bold mt-2";
          leadAuthMsg.textContent = "Signed in";
          leadEmail.value = "";
          leadPassword.value = "";
        } catch (err) {
          console.error("[auth] error", err);
          leadAuthMsg.textContent = `Sign in failed: ${
            err.code || err.message
          }`;
          leadAuthMsg.className = "has-text-danger has-text-weight-bold mt-2";
        }
      });

      // Sign out (same as events page)
      leadSignOutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          leadAuthMsg.className = "has-text-info has-text-weight-bold mt-2";
          leadAuthMsg.textContent = "Signed out";
          leadEmail.value = "";
          leadPassword.value = "";
        } catch (e) {
          console.error("[auth] sign out error", e);
          leadAuthMsg.textContent = `Sign out failed: ${e.code || e.message}`;
          leadAuthMsg.className = "has-text-danger has-text-weight-bold mt-2";
        }
      });

      // Auth state changes (same pattern as events page)
      onAuthStateChanged(auth, async (user) => {
        const admin = await isAdmin(user?.uid);
        if (admin) {
          leaderForm.classList.remove("is-hidden");
          leadAdminList.classList.remove("is-hidden");
          leadAuthMsg.textContent = `Signed in as admin: ${user.email}`;
          leadAuthMsg.className = "has-text-success has-text-weight-bold mt-2";
        } else {
          leaderForm.classList.add("is-hidden");
          leadAdminList.classList.add("is-hidden");
          if (user) {
            leadAuthMsg.textContent = "Not authorized for admin actions";
            leadAuthMsg.className = "has-text-danger has-text-weight-bold mt-2";
          } else {
            leadAuthMsg.textContent = "";
          }
        }
      });

      // Save profile (same pattern as events save)
      leaderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        leadFormMsg.textContent = "";

        const id = leaderIdEl.value?.trim();
        const payload = {
          name: leaderNameEl.value.trim(),
          title: leaderTitleEl.value.trim(),
          image: leaderImageEl.value.trim() || "",
          bio: leaderBioEl.value.trim() || "",
          updatedAt: serverTimestamp(),
        };

        if (!payload.name || !payload.title) {
          leadFormMsg.textContent = "Please provide name and title";
          leadFormMsg.className = "has-text-danger has-text-weight-bold mt-2";
          return;
        }

        try {
          if (id && id.length > 0) {
            // Update existing profile
            console.log("Updating existing profile:", id);
            await setDoc(doc(db, "leaders", id), payload, { merge: true });
            leadFormMsg.textContent = "Profile updated successfully!";
            leadFormMsg.className =
              "has-text-success has-text-weight-bold mt-2";
          } else {
            // Create new profile with auto-generated ID
            console.log("Creating new profile");
            const docRef = await addDoc(collection(db, "leaders"), {
              ...payload,
              createdAt: serverTimestamp(),
            });
            console.log("New profile created with ID:", docRef.id);
            leadFormMsg.textContent = "Profile created successfully!";
            leadFormMsg.className =
              "has-text-success has-text-weight-bold mt-2";
          }

          // Reset form after successful save
          leaderIdEl.value = "";
          leaderNameEl.value = "";
          leaderTitleEl.value = "";
          leaderImageEl.value = "";
          leaderBioEl.value = "";
        } catch (err) {
          console.error("Save error:", err);
          leadFormMsg.textContent = `Save failed: ${err.message}`;
          leadFormMsg.className = "has-text-danger has-text-weight-bold mt-2";
        }
      });

      // Reset form
      leadResetBtn.addEventListener("click", () => {
        leaderIdEl.value = "";
        leaderNameEl.value = "";
        leaderTitleEl.value = "";
        leaderImageEl.value = "";
        leaderBioEl.value = "";
        leadFormMsg.textContent = "";
      });

      // Load for edit (same as events)
      async function loadForEdit(id) {
        const snap = await getDoc(doc(db, "leaders", id));
        if (!snap.exists()) return;
        const ld = snap.data();
        leaderIdEl.value = snap.id;
        leaderNameEl.value = ld.name || "";
        leaderTitleEl.value = ld.title || "";
        leaderImageEl.value = ld.image || "";
        leaderBioEl.value = ld.bio || "";
        leadFormMsg.textContent = "Loaded for edit";
        leadFormMsg.className = "has-text-info has-text-weight-bold mt-2";
        openModal();
      }

      // Delete (same as events)
      async function doDelete(id) {
        if (!confirm("Delete this profile?")) return;
        try {
          await deleteDoc(doc(db, "leaders", id));
        } catch (e) {
          console.error("delete leader", e);
          alert("Delete failed");
        }
      }
    </script>
  </body>
</html>
